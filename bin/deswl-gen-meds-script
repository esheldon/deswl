#!/usr/bin/env python
"""
    %prog [options] medsconf coadd_run band

Generate shell script to run make-meds-input and make-cutouts.

meds_config is a meds config id, e.g. meds001
"""

import os,sys
from sys import stderr
import deswl
import desdb

from optparse import OptionParser
parser = OptionParser(__doc__)

parser.add_option('--whose',default='wlpipe',
                  help="Code owner, default %default")
parser.add_option('--vers',default='work',
                  help="Code version, default %default")

_template="""#!/bin/bash
# we write stdout from make-meds-input to the meds_input file; log messages
# go to stderr
#
# make-cutouts only writes to stderr
#
# the exit status from those programs (the last to run) is written to the
# meds_status file and becomes the exit status of this program.
#
# there should be no stdout from this script, only stderr
#
# in production this script is called by a pbs submit script and the
# stderr is written to a log file (meds_log)

module unload shapelets-{whose} && module load shapelets-{whose}/{vers}
module unload deswl-{whose} && module load deswl-{whose}/{vers}

coadd_file="{coadd_image}"
coaddcat_file="{coadd_cat}"
coadd_srclist="{meds_srclist}"
cutout_file="{meds_file}"
meds_input="{meds_input}"
medsconf={medsconf}
meds_status="{meds_status}"

min_boxsize={min_boxsize}
max_boxsize={max_boxsize}

d=$(dirname "$cutout_file")
mkdir -p "$d"

echo "creating meds input $meds_input" 1>&2
make-meds-input "$coaddcat_file" $min_boxsize $max_boxsize > "$meds_input"

exit_status=$?
if [[ $? == "0" ]]; then

    # keywords after cutout_file= are just extra medatdata to be written into
    # the metadata table; they are not used by the code

    cmd="
    make-cutouts
        coadd_file=$coadd_file
        cat_file=$meds_input
        coadd_srclist=$coadd_srclist
        cutout_file=$cutout_file
        medsconf=$medsconf
        coaddcat_file=$coaddcat_file
        min_boxsize=$min_boxsize
        max_boxsize=$max_boxsize
    "

    $cmd

    exit_status=$?
fi

mess="writing status $exit_status to meds_status:
    $meds_status"
echo $mess 1>&2

echo "exit_status: $exit_status" > "$meds_status"
exit $exit_status
"""

def make_dirs(script_file, meds_file):
    d=os.path.dirname(script_file)
    if not os.path.exists(d):
        print 'making dir:',d
        os.makedirs(d)
    d=os.path.dirname(meds_file)
    if not os.path.exists(d):
        print 'making dir:',d
        os.makedirs(d)

def main():

    options, args = parser.parse_args(sys.argv[1:])
    if len(args) < 3:
        parser.print_help()
        sys.exit(45)

    medsconf=args[0]
    coadd_run=args[1]
    band=args[2]

    conf=deswl.files.read_meds_config(medsconf)

    df=desdb.files.DESFiles()
    cf=desdb.files.Coadd(run=coadd_run, band=band)
    cf.load()

    coadd_image=df.url(type='coadd_image',
                       run=coadd_run,
                       tilename=cf['tilename'],
                       band=band)
    coadd_cat=df.url(type='coadd_cat',
                     run=coadd_run,
                     tilename=cf['tilename'],
                     band=band)

    meds_srclist=df.url(medsconf=medsconf,
                        type='meds_srclist',
                        coaded_run=coadd_run,
                        tilename=cf['tilename'],
                        band=band)
    meds_input=df.url(medsconf=medsconf,
                      type='meds_input',
                      coadd_run=coadd_run,
                      tilename=cf['tilename'],
                      band=band)

    meds_file=df.url(medsconf=medsconf,
                     type='meds',
                     coadd_run=coadd_run,
                     tilename=cf['tilename'],
                     band=band)

    meds_status=df.url(medsconf=medsconf,
                       type='meds_status',
                       coadd_run=coadd_run,
                       tilename=cf['tilename'],
                       band=band)


    text=_template.format(medsconf=medsconf,
                          vers=options.vers,
                          whose=options.whose,
                          coadd_image=coadd_image,
                          coadd_cat=coadd_cat,
                          meds_input=meds_input,
                          meds_srclist=meds_srclist,
                          min_boxsize=conf['min_boxsize'],
                          max_boxsize=conf['max_boxsize'],
                          meds_file=meds_file,
                          meds_status=meds_status)

    script_file=df.url(medsconf=medsconf,
                       type='meds_script',
                       coass_run=coadd_run,
                       tilename=cf['tilename'],
                       band=band)

    make_dirs(script_file, meds_file)
    
    print script_file
    with open(script_file,'w') as fobj:
        fobj.write(text)

main()

