#!/usr/bin/python
"""
    %prog [options] medsconf coadd_run band

This is the list of red image files and background image files
"""

import sys
import os
import desdb

from optparse import OptionParser
parser=OptionParser(__doc__)

parser.add_option('-c','--check',action='store_true',
                  help="check that files exist")

def do_check(r):
    nmissing=0
    for ftype in ['red_image','red_bkg','red_seg']:
        if not os.path.exists(r[ftype]):
            print "missing %s %s %s: %s" % (r['run'],r['exposurename'],ftype,r[ftype])
        nmissing+=1

    return nmissing

def main():
    options,args = parser.parse_args(sys.argv[1:])

    if len(args) < 3:
        parser.print_help()
        sys.exit(1)

    medsconf=args[0]
    coadd_run=args[1]
    band=args[2]

    cf=desdb.files.Coadd(coadd_run=coadd_run,
                         band=band)

    cf.load(srclist=True)

    df=desdb.files.DESFiles()
    srclist=df.url(medsconf=medsconf,
                   type='meds_srclist',
                   coadd_run=coadd_run,
                   tilename=cf['tilename'],
                   band=band)

    d=os.path.dirname(srclist)
    if not os.path.exists(d):
        os.makedirs(d)

    print 'writing:',srclist

    nmissing=0
    with open(srclist,'w') as fobj:
        for r in cf.srclist:

            if options.check:
                nmissing += do_check(r)

            line='%s %s %s %s\n'
            line = line % (r['red_image'],r['red_bkg'],r['red_seg'],r['magzp'])
            fobj.write(line)
    if options.check:
        print 'nmissing: ',nmissing
main()
