#!/usr/bin/python
"""
    %prog [options] medsconf coadd_run band

This is the list of red image files and background image files
"""

import sys
import os
import desdb

from optparse import OptionParser
parser=OptionParser(__doc__)

parser.add_option("--dbi",action='store_true',
                  help="use i as the detection band")

def main():
    options,args = parser.parse_args(sys.argv[1:])

    if len(args) < 3:
        parser.print_help()
        sys.exit(1)

    medsconf=args[0]
    coadd_run=args[1]
    band=args[2]

    if options.dbi:
        dbi='_dbi'
    else:
        dbi=''

    cf=desdb.files.Coadd(coadd_run=coadd_run,
                         band=band)

    cf.load(srclist=True)

    df=desdb.files.DESFiles()
    srclist=df.url(medsconf=medsconf,
                   type='meds%s_srclist' % dbi,
                   coadd_run=coadd_run,
                   tilename=cf['tilename'],
                   band=band)

    d=os.path.dirname(srclist)
    if not os.path.exists(d):
        os.makedirs(d)

    print 'writing:',srclist
    with open(srclist,'w') as fobj:
        for r in cf.srclist:
            line='%s %s %s %s\n'
            line = line % (r['red_image'],r['red_bkg'],r['red_seg'],r['magzp'])
            fobj.write(line)
                         
main()
