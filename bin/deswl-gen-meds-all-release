#!/usr/bin/env python
"""
    %prog [options] medsconf band

Generate shell scripts to run make-meds-input and make-cutouts.

meds_config is a meds config id, e.g. meds001
"""

import os,sys
from sys import stderr
import deswl
import desdb

from optparse import OptionParser
parser = OptionParser(__doc__)

def cut_blacklist(release, runs):
    nr=len(runs)

    blacklist = deswl.files.get_coadd_blacklist(release)

    runs_new=[]
    for run in runs:
        found=False
        for tile in blacklist:
            if tile in run:
                found=True

        if not found:
            runs_new.append(run)

    nr_new=len(runs_new)
    print 'black listed %d/%d' % (nr-nr_new, nr)
    return runs_new

def main():
    options, args = parser.parse_args(sys.argv[1:])
    if len(args) < 2:
        parser.print_help()
        sys.exit(45)

    medsconf=args[0]
    band=args[1]

    # we require the tiles have at least these bands
    allbands=['g','r','i','z']
    if band not in allbands:
        raise ValueError("bad band '%s'" % band)

    conf=deswl.files.read_meds_config(medsconf)

    # can be a list
    release=conf['release']

    print 'getting run list'
    runs=desdb.files.get_release_runs(release, withbands=allbands)

    #runs=cut_blacklist(release, runs)

    nrun=len(runs)
    for i,run in enumerate(runs):
        print >>stderr,'*'*70
        print >>stderr,'%d/%d' % (i+1,nrun)
        cmd='deswl-gen-meds-all %s %s %s' % (medsconf,run,band)
        os.system(cmd)

main()

